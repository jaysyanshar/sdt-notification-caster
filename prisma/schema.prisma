// Prisma schema for Notification Caster

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MessageType {
  BIRTHDAY
}

enum MessageStatus {
  PENDING
  SENDING
  SENT
  RETRY
}

model User {
  id        String       @id @default(uuid()) @db.Uuid
  firstName String
  lastName  String
  email     String       @unique
  birthDate DateTime     @db.Date
  timezone  String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  messageJobs MessageJob[]
}

model MessageJob {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String?       @db.Uuid
  type             MessageType
  scheduledAtUtc   DateTime
  status           MessageStatus
  attempts         Int           @default(0)
  nextAttemptAtUtc DateTime?
  lastError        String?
  sentAtUtc        DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@index([status, scheduledAtUtc, nextAttemptAtUtc])
  // Unique constraint prevents duplicate jobs for same user/type/time
  // Note: Uses millisecond precision. Rapid creates/updates could cause constraint violations
  // if jobs are created at the exact same UTC millisecond. The application should handle
  // this gracefully by checking for existing jobs first or catching the violation.
  @@unique([userId, type, scheduledAtUtc])
}
